<div class="container">
  <app-header />
  <app-live-session-instructions />

  <div class="actions-container">
    <button mat-stroked-button class="invite-btn" (click)="copyLink()">
      <mat-icon>link</mat-icon> Copy Invite Link
    </button>
  </div>

  <app-live-status-bar [membersList]="memberList()" [isActive]="true" [isClosed]="isClosed()" />

  @if (sessionData(); as session) {
  <div class="session-grid">
    <mat-card appearance="outlined" class="input-card user-card" [class.disabled-card]="isClosed()">
      <mat-card-header>
        <div class="header-icon-wrapper">
          <mat-icon>person_edit</mat-icon>
        </div>
        <div class="header-text">
          <mat-card-title>Your Data</mat-card-title>
          <mat-card-subtitle>
            {{ isClosed() ? 'Session is locked' : 'Enter your character details' }}
          </mat-card-subtitle>
        </div>
      </mat-card-header>

      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Character Name</mat-label>
          <input
            matInput
            [ngModel]="myName()"
            (ngModelChange)="myName.set($event); triggerUpdate()"
            [disabled]="isClosed()"
            placeholder="e.g. Eternal Oblivion"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width log-field">
          <mat-label>Session Log</mat-label>
          <textarea
            matInput
            [ngModel]="myLog()"
            (ngModelChange)="myLog.set($event); triggerUpdate()"
            [disabled]="isClosed()"
            placeholder="Paste 'Looted Items:...' here"
          ></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    @if (isLeader()) {
    <mat-card appearance="raised" class="input-card leader-card">
      <mat-card-header>
        <div class="header-icon-wrapper gold">
          <mat-icon>emoji_events</mat-icon>
        </div>
        <div class="header-text">
          <mat-card-title>Party Analyzer</mat-card-title>
          <mat-card-subtitle class="leader-badge">ðŸ‘‘ You are the Leader</mat-card-subtitle>
        </div>
      </mat-card-header>

      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width log-field">
          <mat-label>Party Analyzer Log</mat-label>
          <textarea
            matInput
            [ngModel]="session.partyLog"
            (ngModelChange)="updatePartyLog($event)"
            placeholder="Paste Balance log here..."
            [disabled]="isClosed()"
          ></textarea>
        </mat-form-field>

        <div class="lobby-section">
          <h3>Lobby Status</h3>
          <app-session-members [members]="memberList()" />
        </div>
      </mat-card-content>

      @if (!isClosed()) {
      <mat-card-actions align="end">
        <button mat-fab extended color="primary" (click)="calculate()" [disabled]="!canSubmit()">
          <mat-icon>publish</mat-icon> Calculate & Publish
        </button>
      </mat-card-actions>
      }
    </mat-card>
    } @else { @if (!results()) {
    <mat-card appearance="outlined" class="input-card waiting-card">
      <mat-card-header>
        <div class="header-icon-wrapper blue">
          <mat-icon>groups</mat-icon>
        </div>
        <div class="header-text">
          <mat-card-title>Waiting for Leader</mat-card-title>
          <mat-card-subtitle>The leader will calculate the split</mat-card-subtitle>
        </div>
      </mat-card-header>

      <mat-card-content>
        <p class="info-text">
          Wait for all members to verify their logs. The page will update automatically when the
          calculation is done.
        </p>

        <div class="lobby-section">
          <h3>Members Ready</h3>
          <app-session-members [members]="memberList()" />
        </div>
      </mat-card-content>
    </mat-card>

    } @else {
    <mat-card appearance="raised" class="input-card success-card">
      <mat-card-header>
        <div class="header-icon-wrapper green">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="header-text">
          <mat-card-title>Calculation Complete</mat-card-title>
          <mat-card-subtitle>The loot has been split!</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="lobby-section">
          <h3>Members</h3>
          <app-session-members [members]="memberList()" />
        </div>
        <p class="success-text">Scroll down to see your transfer details and summary.</p>
        <button mat-stroked-button class="scroll-btn" (click)="scrollToResults()">
          <mat-icon>arrow_downward</mat-icon> View Details
        </button>
      </mat-card-content>
    </mat-card>
    } }
  </div>

  @if (results(); as res) {
  <div class="results-wrapper">
    <app-loot-report [canShareUrls]="false" [result]="res"></app-loot-report>
  </div>
  } } @else {
  <div class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Syncing with Party Session...</p>
  </div>
  }
</div>
