@let res = result();
<div class="results-container">
  <mat-divider></mat-divider>

  <div class="financial-section">
    <h2>Liquid Balance Calculation</h2>
    <table mat-table [dataSource]="res.financials" class="mat-elevation-z2 financial-table">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Player</th>
        <td mat-cell *matCellDef="let element">{{ element.name }}</td>
      </ng-container>

      <ng-container matColumnDef="original">
        <th mat-header-cell *matHeaderCellDef>Log Balance</th>
        <td mat-cell *matCellDef="let element">
          {{ element.originalBalance | number }}
        </td>
      </ng-container>

      <ng-container matColumnDef="deduction">
        <th mat-header-cell *matHeaderCellDef>Items Kept</th>
        <td mat-cell *matCellDef="let element" class="negative-val">
          - {{ element.productValueDeducted | number }}
        </td>
      </ng-container>

      <ng-container matColumnDef="final">
        <th mat-header-cell *matHeaderCellDef>Liquid Balance</th>
        <td
          mat-cell
          *matCellDef="let element"
          [class.profit]="element.finalLiquidBalance > 0"
          [class.waste]="element.finalLiquidBalance < 0"
        >
          <strong>{{ element.finalLiquidBalance | number }}</strong>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <div class="center-xy" style="margin-top: 1rem">
      <div class="party-total">Total Liquid Profit: {{ res.partyBalance | number }} gp</div>
      <button
        mat-flat-button
        color="accent"
        class="share-btn"
        (click)="!isLoadingShortUrlGeneration() && shareShortUrl.emit()"
      >
        @if (isLoadingShortUrlGeneration()) {
        <div class="center-xy">
          <mat-spinner diameter="24"></mat-spinner>
        </div>
        } @else {
        <div class="center-xy" style="gap: var(--mat-button-filled-icon-spacing, 8px)">
          <mat-icon>share</mat-icon>
          Generate TinyURL Share Link
        </div>
        }
      </button>
      <button mat-flat-button color="accent" class="share-btn" (click)="shareLongUrl.emit()">
        <mat-icon>share</mat-icon>
        Generate Long Share Link
      </button>
    </div>
  </div>

  <div class="settlement-grid">
    <mat-card appearance="raised" class="result-card gold-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="gold-icon">payments</mat-icon>
        <mat-card-title>Bank Transfers</mat-card-title>
        <mat-card-subtitle>Settle these to equalize profit</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (res.goldInstructions.length === 0) {
        <p>Balances are equal. No transfers needed.</p>
        }
        <div class="instruction-list">
          @for (ins of res.goldInstructions; track ins.from + ins.to) {
          <div class="instruction-row gold-row">
            <div class="row-text">
              <span class="player source">{{ ins.from }}</span>
              <span class="arrow">transfer</span>
              <span class="amount">{{ ins.amount | number }}</span>
              <span class="arrow">to</span>
              <span class="player dest">{{ ins.to }}</span>
            </div>
            <button
              mat-icon-button
              type="button"
              class="copy-btn"
              (click)="copyTransfer(ins)"
              title="Copy NPC Command"
            >
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="raised" class="result-card info-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>compare_arrows</mat-icon>
        <mat-card-title>Item Transfers</mat-card-title>
        <mat-card-subtitle>Physical items to trade</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (res.groupedItemInstructions.length === 0) {
        <p class="empty-text">No item trades needed.</p>
        }
        <div class="instruction-list">
          @for (group of res.groupedItemInstructions; track group.from + group.to) {
          <div class="trade-group">
            <div class="trade-header">
              <span class="player source">{{ group.from }}</span>
              <span class="arrow-text">trades to</span>
              <span class="player dest">{{ group.to }}</span>
            </div>

            <div class="trade-items">
              @for (item of group.items; track item.name) {
              <div class="trade-item-row">
                <span class="qty">{{ item.amount }}x</span>
                <span class="name">{{ item.name }}</span>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="raised" class="result-card product-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>category</mat-icon>
        <mat-card-title>Total Products</mat-card-title>
        <mat-card-subtitle>Total Value: {{ res.totalValue | number }} gp</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (res.totalLoot.length === 0) {
        <p class="empty-text">No creature products found.</p>
        }
        <mat-chip-set>
          @for (item of res.totalLoot; track item.name) {
          <mat-chip class="loot-chip">
            <span class="chip-qty">{{ item.amount }}x</span> {{ item.name }}
          </mat-chip>
          }
        </mat-chip-set>

        @if (res.remainder.length > 0) {
        <mat-divider style="margin: 1rem 0"></mat-divider>
        <div class="remainder-section">
          <small>Remainder (Unsplit):</small>
          @for (item of res.remainder; track item.name) {
          <span class="remainder-item">{{ item.amount }}x {{ item.name }}</span>
          }
        </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
